---
// GLightbox component for image galleries
---

<script>
  import GLightbox from 'glightbox';
  import 'glightbox/dist/css/glightbox.min.css';

  const escapeHtml = (str: string) =>
    str
      .replace(/&/g, '&amp;')
      .replace(/</g, '&lt;')
      .replace(/>/g, '&gt;')
      .replace(/"/g, '&quot;')
      .replace(/'/g, '&#39;');


  function syncLightboxCaptions(root = document) {
    const links = Array.from(
      root.querySelectorAll<HTMLAnchorElement>('a.glightbox')
    );

    links.forEach(link => {
      const img = link.querySelector('img');
      const seoCaption = link.dataset.seoCaption?.trim();
      const visibleCaption = link.querySelector('[data-gallery-caption]');

      // If data-glightbox already exists (from GalleryLightbox component), skip
      if (!link.dataset.glightbox) {
        // Handle old data-caption format (hero images, etc)
        const caption = link.dataset.caption?.trim();
        if (caption) {
          const escapeHtml = (str: string) => str.replace(/"/g, '&quot;').replace(/'/g, '&#39;');
          link.dataset.glightbox = `title: ${escapeHtml(caption)}`;
        }
      }

      // Sync visible gallery caption if needed
      if (visibleCaption) {
        const glightboxAttr = link.dataset.glightbox;
        if (glightboxAttr) {
          const titleMatch = glightboxAttr.match(/title:\s*([^;]+)/);
          if (titleMatch && titleMatch[1] && visibleCaption.textContent !== titleMatch[1]) {
            visibleCaption.textContent = titleMatch[1].trim();
          }
        }
      }

      // Set SEO alt text on images
      if (img && seoCaption) {
        img.alt = seoCaption;
      }
    });
  }

  function initGLightbox() {
    syncLightboxCaptions();

    // Initialize GLightbox
    const lightbox = GLightbox({
      touchNavigation: true,
      loop: true,
      autoplayVideos: true,
      descPosition: 'bottom',
      plyr: {
        css: 'https://cdn.plyr.io/3.6.8/plyr.css',
        js: 'https://cdn.plyr.io/3.6.8/plyr.js',
        config: {
          ratio: '16:9',
          youtube: {
            noCookie: true,
            rel: 0,
            showinfo: 0,
            iv_load_policy: 3
          },
          vimeo: {
            byline: false,
            portrait: false,
            title: false,
            transparent: false
          }
        }
      }
    });

    // Re-initialize when navigating (for Astro transitions)
    document.addEventListener('astro:page-load', () => {
      syncLightboxCaptions();
      lightbox.reload();
    });
  }

  // Initialize on page load
  document.addEventListener('DOMContentLoaded', initGLightbox);

  // Re-initialize after page transitions
  document.addEventListener('astro:page-load', initGLightbox);
</script>

<style is:global>
  /* Caption styling */
  .glightbox-clean .gslide-title {
    margin-bottom: 4px !important;
  }


  /* Navigation buttons */
  .glightbox-clean .gprev,
  .glightbox-clean .gnext {
    background: rgba(0, 0, 0, 0.6);
    border-radius: 50%;
  }

  .glightbox-clean .gprev:hover,
  .glightbox-clean .gnext:hover {
    background: rgba(0, 0, 0, 0.8);
  }
</style>
