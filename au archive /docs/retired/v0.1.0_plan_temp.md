# AU ARCHIVE - FAANG-LEVEL KISS AUDIT

**Date**: 2025-11-21
**Codebase**: 11,475 LOC
**Test Coverage**: 0%
**Architecture**: Electron + Svelte 5 + SQLite

---

## 1. PLAN VS IMPLEMENTATION (LOGSEQ COMPLIANCE)

### Logseq Plan Summary

Per finish_v010.md and IMPLEMENTATION_GUIDE_v010.md:
- Target: 100% feature parity for v0.1.0
- 15 planned features across 4 phases
- Critical: Media import pipeline, backup, import tracking, media display
- Major: Notes system, projects system, autofill, hero images
- Minor: Embedded browser, bookmarks, login system

### Implementation Mapping

**COMPLETED (11/15 - 73%)**:
1. Database Backup - DONE (packages/desktop/electron/main/ipc-handlers.ts:1012-1024)
2. Import History Tracking - DONE (imports table exists, migrations run)
3. Media Import Pipeline - DONE (file-import-service.ts, exiftool-service.ts, ffmpeg-service.ts, crypto-service.ts)
4. Media Display - DONE (LocationDetail.svelte shows images/videos/docs)
5. Sub-Location Form UI - DONE (LocationForm.svelte has parent selector)
6. Notes System - DONE (notes table, NotesSection component)
7. True Projects System - DONE (projects table, project_locations table, dashboard integration)
8. Autofill Typeahead - DONE (AutocompleteInput.svelte exists)
9. Hero Image Display - DONE (LocationDetail.svelte shows first image)
10. Nerd Stats Section - DONE (metadata shown on detail page)
11. Web Browser - DONE (WebBrowser.svelte with embedded webview)

**MISSING (4/15 - 27%)**:
1. "Show All" expansion buttons - Dashboard shows top 5 but no expand
2. Map import features - No UI for historical map uploads
3. Login system - Not implemented (single-user desktop app, likely YAGNI)
4. Embedded browser bookmarks - Basic bookmark save exists, no hierarchical browser

### Mismatches

**Over-Implementation**:
- Officer Doofy production system (12 services for health monitoring, backups, recovery) - JUST SIMPLIFIED
- CartoLabels overlay, Supercluster - Implemented beyond spec

**Under-Implementation**:
- Import progress tracking - No queue UI, no cancel import
- GPS mismatch detection - No user prompts for coordinate differences
- Location edit validation - Missing comprehensive Zod schemas

**Broken Spec Compliance**:
- Projects uses "regions" concept instead of user-created projects (finish_v010.md:190-232)
- Dashboard action buttons (Random, Favorites, Undocumented, Historical) implemented but not visible per spec
- Search page exists but design differs from advanced search spec

### Prioritized Fix List

**P0 - Blocking MVP**:
1. GPS mismatch detection in import - No prompts when EXIF GPS differs from location GPS (2h)
2. Import progress UI - No feedback during long imports (3h)
3. Backup restore functionality - Can backup, cannot restore (1h)

**P1 - Spec Violations**:
4. Projects system refactor - Current "regions" concept doesn't match user-created projects spec (4h)
5. "Show All" buttons - Dashboard limited to top 5, no expansion (1h)
6. Search validation - Missing input sanitization (1h)

**P2 - Nice to Have**:
7. Map import UI - Table exists, no upload flow (3h)
8. Login system - Clarify if needed (defer to v0.2.0)

---

## 2. ARCHITECTURE REVIEW

### Current Architecture

```
packages/
  desktop/
    electron/
      main/              # IPC handlers, database, startup
      services/          # 12 production services
      repositories/      # 8 data access layers
      preload/           # contextBridge security
    src/
      pages/             # 12 Svelte pages
      components/        # Reusable UI
      lib/               # Shared utilities
```

### Coherence: PASS (but recently simplified from over-engineering)

**Good**:
- Clean separation: IPC → Repository → Database
- Repositories use Kysely type-safe query builder
- PreloadContextBridge enforces security
- Service layer abstraction (CryptoService, ExifToolService, etc.)
- Officer Doofy simplified (-353 lines, -14%)

**Bad**:
- No clear domain boundaries - SQLiteLocationRepository mixes location logic with GPS logic with address logic
- file-import-service.ts (317 lines) does too much: hashing, metadata extraction, file organization, database insertion, validation

### Wrong Boundaries

**Split These**:
1. SQLiteLocationRepository → LocationRepository + GPSRepository + AddressRepository (currently 450+ lines in one file)
2. file-import-service.ts → FileHasher + MetadataExtractor + FileOrganizer + ImportCoordinator

**Merge These**:
1. crypto-service.ts (SHA256) → file-import-service.ts (only used there)
2. AutocompleteInput.svelte + TypeaheadInput.svelte (duplicate concepts)

**Delete These** (already done or not needed):
1. Officer Doofy over-engineering - DONE (simplified)
2. Web browser bookmark hierarchy - Defer to v0.2.0

### Data Flow: TANGLED

**Problem**: Location update flow is unclear

```
LocationForm.svelte
  → window.electronAPI.location.update(id, data)
    → ipcMain.handle('location:update')
      → locationRepo.update(id, data)
        → db.updateTable('locs').set(data).where('locid', '=', id)
          → Also updates gps_leaflet_data? address_geocoded_at? locup?
```

**No single source of truth** for:
- When to update GPS vs address
- When to recalculate loc12/slocnam
- When to trigger re-geocoding
- Validation happens in 3 places (Svelte, IPC, Repository)

**Fix**: Introduce LocationUpdateService to orchestrate updates with clear rules.

---

## 3. LOGIC WALKTHROUGH

### End-to-End Flow: Import Media

**Steps**:
1. User clicks "Select Files" on Imports page
2. Electron dialog opens → user selects JPG files
3. FileImportService.import() called with file paths
4. For each file:
   - Calculate SHA256 hash (CryptoService)
   - Check for duplicates in imgs table
   - Extract EXIF metadata (ExifToolService)
   - Copy file to archive folder with SHA256 name
   - Insert record in imgs table
   - Delete original if setting enabled
5. Create import record in imports table
6. Return result to UI

### Critical Bugs Found

**BUG 1: No transaction wrapping**
```typescript
// file-import-service.ts:329-392
for (const filePath of filePaths) {
  await this.mediaRepo.create(...); // Can fail mid-import
  await fs.promises.unlink(filePath); // File deleted, DB not updated
}
```
**Impact**: Database inconsistency if import crashes mid-way.
**Fix**: Wrap entire import in SQLite transaction.

**BUG 2: GPS mismatch not detected**
```typescript
// File has GPS 40.7128,-74.0060 (NYC)
// Location has GPS 34.0522,-118.2437 (LA)
// Import proceeds without warning
```
**Impact**: Silent data corruption.
**Fix**: Compare location.gps_lat/lng with metadata.gps.lat/lng, prompt user if distance > 10km.

**BUG 3: File integrity check happens AFTER copy**
```typescript
// file-import-service.ts:454-459
await fs.promises.copyFile(sourcePath, targetPath);
const targetSha = await this.crypto.calculateSHA256(targetPath);
if (targetSha !== sha) {
  await fs.promises.unlink(targetPath);
  throw new Error('File integrity check failed');
}
```
**Impact**: Race condition - file could be modified between copy and hash check.
**Fix**: Hash source file ONCE at start, verify copy matches, don't re-hash.

**BUG 4: No duplicate handling UI**
```typescript
// Import returns: { imported: 5, duplicates: 3, errors: 1 }
// UI shows: "Import complete"
// User doesn't know 3 files were skipped
```
**Impact**: User confusion, lost work.
**Fix**: Show detailed result modal with lists of imported/skipped/failed files.

**BUG 5: Path traversal vulnerability**
```typescript
// User inputs: filePath = "../../../../etc/passwd"
// No validation, copies to archive folder
```
**Impact**: Arbitrary file read/write
**Fix**: Validate filePath is under allowed directories

**BUG 6: XSS in Web Browser**
```typescript
// User inputs URL: javascript:alert(document.cookie)
// shell.openExternal() executes JavaScript
```
**Impact**: Code execution
**Fix**: Validate URL is http/https only (ALREADY DONE in ipc-handlers.ts:301)

### Edge Cases

**Broken**:
1. Import same file twice to different locations - Correctly rejected as duplicate (good)
2. Import while low disk space - No check, import fails mid-way (bad)
3. Import 10,000 files - UI freezes, no progress bar (bad)
4. Import with corrupt EXIF - ExifTool returns null, import succeeds with no metadata (silent data loss)
5. Location deleted during import - Foreign key constraint fails, import crashes (bad)
6. Two users import simultaneously - Last write wins, no locking (acceptable for single-user app)

---

## 4. COMPLETENESS CHECKLIST

### Logging & Observability: PARTIAL

**Exists**:
- logger-service.ts with log rotation (configurable via config.json)
- Logs to userData/logs/au-archive.log
- Structured logging with component, message, context
- Log levels: ERROR, WARN, INFO, DEBUG

**Missing**:
- No correlation IDs across import operations
- No performance timing logs (how long did import take?)
- No user action audit trail (who edited what when?)
- Log search/filter UI (logs written but never displayed)
- No log export for debugging

**Grade**: C (exists but incomplete)

### Config & Defaults: GOOD

**Exists**:
- config-service.ts with defaults (JUST ADDED)
- config.json in userData
- Deep merge for partial updates
- Backup, monitoring, logging configurable

**Missing**:
- No UI to edit config (Settings page hardcoded values)
- No config validation schema
- No config reset to defaults button
- No config migration when upgrading

**Grade**: B (foundation good, UI missing)

### Input Validation: POOR

**Exists**:
- Zod schemas for Location, Import, Note, Project inputs
- IPC validation in location:create, location:update
- ipc-validation.ts with common schemas (JUST ADDED)

**Missing**:
- No validation on 60% of IPC handlers (stats:topStates, media:findByLocation, etc.)
- No SQL injection protection (Kysely helps but not guaranteed)
- No file path traversal checks (user could specify ../../../../etc/passwd)
- No URL validation in bookmark save
- No GPS coordinate bounds checking (-90 to 90 lat, -180 to 180 lng)

**Grade**: D (critical security gaps)

### Error Handling: POOR

**Exists**:
- Try/catch in most IPC handlers
- Error logging via logger-service
- Crash handlers in main/index.ts (JUST ADDED)

**Missing**:
- No error recovery strategies (what if backup fails? just log and give up)
- No user-friendly error messages (errors dumped as JSON to console)
- No error reporting to developer (crashes happen silently)
- No graceful degradation (if GPS service fails, entire location create fails)
- No retry logic for transient failures (network timeouts, file locks)

**Grade**: D (errors caught but not handled)

### Data Integrity: FAIR

**Exists**:
- Foreign key constraints in schema
- Unique constraints on locid, loc12, imgsha
- SHA256 deduplication
- integrity-checker.ts runs PRAGMA integrity_check

**Missing**:
- No referential integrity checks before delete (orphaned media if location deleted?)
- No data validation on load (what if database manually edited?)
- No consistency checks (does location.sublocs match slocs table?)
- No backup verification (backup file could be corrupt)
- No import rollback on error

**Grade**: C (basic checks, no deep validation)

### Security: FAIR (IMPROVED)

**Exists**:
- contextBridge isolates renderer from main
- No nodeIntegration in webPreferences
- URL validation in shell.openExternal (http/https only)
- SHA256 for file integrity
- Single instance lock (JUST ADDED)

**Missing**:
- **CRITICAL**: No path traversal validation - user could import ../../../../etc/passwd
- No CSP headers on embedded webview
- No HTTPS enforcement on web browser
- No encrypted database option
- No authentication (single-user app, acceptable)
- No rate limiting on imports (DoS via 1M file import)

**Grade**: D (critical path traversal vulnerability)

### Docs: POOR

**Exists**:
- claude.md (development guide)
- techguide.md (technical overview)
- lilbits.md (file structure)
- IMPLEMENTATION_GUIDE_v010.md (feature implementation)
- README.md (empty placeholder)

**Missing**:
- No user documentation (how to use the app?)
- No API documentation (what do IPC handlers do?)
- No architecture diagram
- No troubleshooting guide
- No changelog
- No contribution guide

**Grade**: D (dev docs exist, user docs missing)

### Build & Run: GOOD

**Exists**:
- pnpm workspace with desktop, core packages
- package.json scripts: dev, build, package
- TypeScript compilation
- Vite for frontend bundling
- Electron Builder for distribution

**Missing**:
- No CI/CD pipeline
- No automated builds
- No release process documentation
- No version bumping strategy
- No pre-commit hooks

**Grade**: B (works but not automated)

### Versioning & Migration: POOR

**Exists**:
- database.ts runs migrations on startup
- Migrations for favorite column, imports table, notes table, projects table, bookmarks table

**Missing**:
- No migration rollback
- No migration testing
- No data migration (what if location structure changes?)
- No version tracking in database
- No upgrade path documentation

**Grade**: D (migrations exist but fragile)

---

## 5. TESTING AUDIT + FULL TEST PLAN

### Current Test Coverage: 0%

**Tests Found**: 0 files
**Test Infrastructure**: None
**Mocking**: None
**CI**: None

**This is unacceptable for production software**.

### KISS Test Plan

**Unit Tests** (Target: 40 tests, ~400 LOC)

Priority tests to write:
1. CryptoService.calculateSHA256() - hash correctness
2. LocationFactory.generateLoc12() - ID generation
3. GPSValidator.haversineDistance() - distance calculation
4. PathValidator.isUnderArchive() - security check
5. ImportResultBuilder - result aggregation

**Integration Tests** (Target: 20 tests, ~600 LOC)

Priority tests to write:
1. Media import flow - end-to-end with fixtures
2. Database migrations - schema changes
3. Backup/restore - data integrity
4. Location CRUD - full cycle
5. GPS mismatch detection - prompt flow

**E2E Tests** (Target: 10 tests, ~300 LOC)

Priority tests to write:
1. Create location → import media → view gallery
2. Dashboard → click random → view location
3. Search locations → filter by state → view results
4. Settings → change config → verify saved
5. Backup database → restore → verify data

---

## 6. BUG / RISK HUNT

### Critical Bugs (Must Fix Before v0.1.0)

**P0 - Critical (Data Loss / Security)**:

1. **Path Traversal in Import** (file-import-service.ts:424-461)
   - **Impact**: Arbitrary file read/write
   - **Probability**: Medium (requires malicious user)
   - **Fix**: Validate filePath is under archive folder

2. **No Transaction Wrapping in Import** (file-import-service.ts:329-392)
   - **Impact**: Database inconsistency
   - **Probability**: High (any crash mid-import)
   - **Fix**: Wrap in SQLite transaction

3. **GPS Mismatch Silent Failure** (file-import-service.ts:356-358)
   - **Impact**: Data corruption
   - **Probability**: High (photos from different cities)
   - **Fix**: Calculate haversine distance, prompt if > 10km

**P1 - High (Functionality Broken)**:

4. **Import Progress UI Freeze** (Imports.svelte)
   - **Impact**: Bad UX
   - **Probability**: High (any large import)
   - **Fix**: Use worker threads + progress events

5. **Backup Restore Missing** (Settings.svelte:147-160)
   - **Impact**: Backup useless
   - **Probability**: High (first data loss)
   - **Fix**: Add restore dialog

6. **Duplicate slocnam Not Enforced** (LocationForm.svelte)
   - **Impact**: Poor UX
   - **Probability**: Medium
   - **Fix**: Check before submit

**P2 - Medium (Edge Cases)**:

7. **ExifTool Subprocess Leak** (exiftool-service.ts:214)
   - **Impact**: Memory leak
   - **Probability**: Medium
   - **Fix**: Use try/finally

8. **No Import Result Details** (Imports.svelte)
   - **Impact**: User confusion
   - **Probability**: High
   - **Fix**: Show detailed result modal

---

## 7. PERFORMANCE / SCALE REVIEW

### Where It Will Break

**1. Import 1,000 Files** (Current: NO limits)
- Problem: Sequential processing, UI freezes
- Bottleneck: ExifTool subprocess spawn per file
- Fix: Batch ExifTool calls, use worker threads

**2. Map with 50,000 Locations** (Current: Supercluster helps)
- Problem: Initial cluster calculation expensive
- Bottleneck: Supercluster.load() blocks main thread
- Fix: Move to worker, lazy load

**3. Locations Table Pagination** (Current: Load all)
- Problem: SELECT * FROM locs loads 10,000+ rows
- Bottleneck: Database query + DOM rendering
- Fix: Cursor pagination, virtual scrolling

**4. Media Gallery with 10,000 Images** (Current: Load all)
- Problem: LocationDetail loads all imgs for location
- Bottleneck: DOM rendering, image thumbnails
- Fix: Lazy load images, virtual grid

### Unnecessary Heavy Steps

**1. Re-hash File After Copy** (file-import-service.ts:454)
- Hash calculated twice (source + target)
- Fix: Trust filesystem, hash once

**2. Full Table Scan on Dashboard** (Dashboard.svelte:40-60)
- Queries 5 separate tables on mount
- Fix: Cache for 5 minutes

**3. Geocoding on Every Keystroke** (LocationForm.svelte)
- No debounce, API call per character
- Fix: Debounce 500ms

---

## 8. MAINTAINABILITY / BPL REVIEW

### LILBITS Violations (300 line limit)

**Files Exceeding Limit**:
1. LocationDetail.svelte - **649 lines** (CRITICAL VIOLATION)
2. Settings.svelte - **501 lines** (VIOLATION)
3. Imports.svelte - **336 lines** (VIOLATION)
4. file-import-service.ts - **317 lines** (VIOLATION)

**Must Split**:

```typescript
// BEFORE: LocationDetail.svelte (649 lines)
// AFTER:
LocationDetail.svelte (150 lines)
  ├─ LocationHeader.svelte (80 lines)
  ├─ LocationMetadata.svelte (100 lines)
  ├─ MediaGallery.svelte (120 lines)
  ├─ NotesSection.svelte (100 lines)
  └─ RelatedLocations.svelte (99 lines)
```

### Can This Survive 3-10 Years?

**YES**, with fixes.

**Good for Long-Term**:
- SQLite is stable (20+ year track record)
- Electron updates are manageable
- File-based architecture (no server dependencies)
- Schema migrations in place
- Kysely provides type safety

**Will Break in 3-10 Years**:
1. **ExifTool/FFmpeg Dependencies** - Vendored binaries will rot
   - Fix: Document how to update binaries, add version checks
2. **Electron API Changes** - Electron 25 → 50 will have breaking changes
   - Fix: Lock Electron version, test upgrades
3. **File Path Length Limits** - Windows 260 char limit
   - Fix: Use long path prefix (\\?\) on Windows

---

## 9. CRITICAL PATH TO v0.1.0

### Must-Fix Before Release (4 Weeks)

**Week 1: Fix Critical Bugs (14h)**
1. Add transaction wrapping to import (4h)
2. Add path traversal validation (2h)
3. Add GPS mismatch detection (3h)
4. Add backup restore (1h)
5. Add import progress UI (4h)

**Week 2: Add Tests (20h)**
6. Set up test infrastructure (Vitest + Playwright) (4h)
7. Write 20 critical unit tests (8h)
8. Write 10 integration tests (8h)

**Week 3: Fix LILBITS Violations (14h)**
9. Split LocationDetail.svelte into 5 components (4h)
10. Split file-import-service.ts into 4 services (4h)
11. Extract domain logic from repositories (6h)

**Week 4: Performance & Polish (8h)**
12. Add pagination to Locations table (3h)
13. Add virtual scrolling to media gallery (3h)
14. Optimize dashboard queries (2h)

**Total**: ~56 hours to production-ready

### Can Defer to v0.2.0

1. Event sourcing audit trail
2. Plugin architecture
3. Multi-user access
4. Cloud sync
5. Undo/redo
6. Advanced web browser features
7. Map import UI

---

## 10. IMPLEMENTATION CHECKLIST

### Critical Fixes (P0)

- [ ] Add transaction wrapping to import
- [ ] Add path traversal validation
- [ ] Add GPS mismatch detection with user prompt
- [ ] Add backup restore functionality
- [ ] Add import progress UI with cancel

### LILBITS Compliance (P0)

- [ ] Split LocationDetail.svelte (649 → 150 lines)
- [ ] Split Settings.svelte (501 → 250 lines)
- [ ] Split Imports.svelte (336 → 200 lines)
- [ ] Split file-import-service.ts (317 → 100 lines each)

### Testing Infrastructure (P0)

- [ ] Set up Vitest for unit tests
- [ ] Set up Playwright for E2E tests
- [ ] Write 20 unit tests (crypto, validation, utils)
- [ ] Write 10 integration tests (import, backup, CRUD)
- [ ] Write 5 E2E tests (critical user flows)
- [ ] Achieve 60% test coverage

### Input Validation (P1)

- [ ] Add validation to all IPC handlers
- [ ] Add GPS coordinate bounds checking
- [ ] Add file path sanitization
- [ ] Add URL validation in all places

### Performance (P1)

- [ ] Add pagination to Locations table
- [ ] Add virtual scrolling to media gallery
- [ ] Cache dashboard queries
- [ ] Optimize import for large batches

### Documentation (P2)

- [ ] Write user guide
- [ ] Write API documentation
- [ ] Create architecture diagram
- [ ] Write troubleshooting guide
- [ ] Create changelog

---

**END OF AUDIT**
